# GitLab CI/CD設定ファイルのサンプル
# このファイルを .gitlab-ci.yml にリネームして使用してください
# devfile.ymlと同じビルド環境を使用することで、開発環境とCI環境の一貫性を保ちます

# 使用するDockerイメージ（devfile.ymlと同じJava 21環境）
image: eclipse-temurin:21-jdk

# ビルドの各ステージ定義
stages:
  - build
  - test
  - package
  - deploy

# 変数定義
variables:
  MAVEN_OPTS: "-Xmx1024m -XX:+UseContainerSupport"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  POSTGRES_DB: migration_db
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_HOST_AUTH_METHOD: trust

# Mavenキャッシュ設定（ビルド時間を短縮）
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository

# 全ジョブ共通の前処理
before_script:
  - echo "Java version:"
  - java -version
  - echo "Maven version:"
  - mvn -version
  # Mavenのローカルリポジトリをプロジェクト内に設定
  - export MAVEN_USER_HOME=`pwd`/.m2

# ビルドジョブ（devfile.ymlのmaven-buildコマンドと同等）
build:
  stage: build
  script:
    - mvn $MAVEN_CLI_OPTS clean compile
  artifacts:
    paths:
      - target/
    expire_in: 1 hour

# テストジョブ（devfile.ymlのmaven-testコマンドと同等）
test:unit:
  stage: test
  services:
    # PostgreSQLサービス（devfile.ymlのpostgresコンテナと同等）
    - name: postgres:15-alpine
      alias: postgres
  variables:
    SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/migration_db
    SPRING_DATASOURCE_USERNAME: postgres
    SPRING_DATASOURCE_PASSWORD: postgres
  script:
    # PostgreSQLの起動を待機
    - apt-get update && apt-get install -y postgresql-client
    - until pg_isready -h postgres -p 5432 -U postgres; do echo "Waiting for postgres..."; sleep 2; done
    - mvn $MAVEN_CLI_OPTS test
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    paths:
      - target/surefire-reports/
      - target/site/jacoco/
    expire_in: 1 week

# パッケージングジョブ（devfile.ymlのmaven-build-with-testsと同等）
package:
  stage: package
  script:
    - mvn $MAVEN_CLI_OPTS package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week
  only:
    - main
    - develop
    - tags

# コード品質チェック（オプション）
code_quality:
  stage: test
  script:
    - mvn $MAVEN_CLI_OPTS verify -DskipTests
  allow_failure: true
  only:
    - merge_requests

# セキュリティスキャン（オプション）
dependency_scanning:
  stage: test
  script:
    - mvn $MAVEN_CLI_OPTS dependency-check:check
  artifacts:
    reports:
      dependency_scanning: target/dependency-check-report.json
  allow_failure: true
  only:
    - main
    - merge_requests

# マージリクエスト用のビルド・テスト
merge_request:
  stage: build
  services:
    - name: postgres:15-alpine
      alias: postgres
  variables:
    SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/migration_db
    SPRING_DATASOURCE_USERNAME: postgres
    SPRING_DATASOURCE_PASSWORD: postgres
  script:
    - apt-get update && apt-get install -y postgresql-client
    - until pg_isready -h postgres -p 5432 -U postgres; do echo "Waiting for postgres..."; sleep 2; done
    - mvn $MAVEN_CLI_OPTS clean package
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 day
  only:
    - merge_requests

# デプロイジョブ（本番環境へのデプロイ例）
deploy_production:
  stage: deploy
  script:
    - echo "Deploying to production server"
    # 実際のデプロイスクリプトをここに記述
    # 例: kubectl apply -f k8s/deployment.yml
    # 例: scp target/*.jar user@production-server:/opt/app/
  environment:
    name: production
    url: https://production.company.com
  when: manual
  only:
    - tags
    - main

# デプロイジョブ（開発環境への自動デプロイ例）
deploy_development:
  stage: deploy
  script:
    - echo "Deploying to development server"
    # 開発環境へのデプロイスクリプト
  environment:
    name: development
    url: https://dev.company.com
  only:
    - develop

# ページ生成（JavaDocやテストレポート）
pages:
  stage: deploy
  script:
    - mvn $MAVEN_CLI_OPTS site
    - mkdir -p public
    - cp -r target/site/* public/
  artifacts:
    paths:
      - public
  only:
    - main

# クリーンアップジョブ（週次実行）
cleanup:
  stage: build
  script:
    - mvn $MAVEN_CLI_OPTS clean
    - rm -rf .m2/repository
  only:
    - schedules
